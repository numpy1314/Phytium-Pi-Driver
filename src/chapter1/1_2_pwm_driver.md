# 1.2 PWM驱动开发
## 1. PWM工作原理
PWM（Pulse Width Modulation）​​ 是一种通过调节脉冲宽度（占空比）来模拟不同模拟量输出的数字控制技术。它利用数字信号（高/低电平）控制模拟电路，广泛应用于电机调速、电源转换、LED调光等领域。其核心是通过调整脉冲的“有效时间比例”实现连续可调的电压、功率或信号输出
![](/src/resource/img/1_2_1_Working_principle_of_PWM.png)
PWM 最关键的两个参数：频率和占空比。

频率是指单位时间内脉冲信号的周期数。比如开关灯，开关一次算一次周期，在 1s 进行多少次开关（开关一次为一个周期）。

占空比是指一个周期内高电平时间和低电平时间的比例。也拿开关当作例子，总共 100s，开了 50s 灯（高电平），关了 50s 灯（低电平），这时候的占空比就为 50%（比例）。

尽管大部分元件仅有高低电平的输出，PWM 仍可通过改变占空比来实现模拟信号量的输出，核心就是输出的平均电压随占孔比的改变而变化，除此之外采用高频率也能让机器更加顺滑地改变占空比

具体生成过程：

1.周期设定（调节频率）
- 通过定时器计数器设定周期值（PWM定时器的工作方式有点像一个精准的节拍器。它的核心是一个计数器，从0开始计数，数到某个设定值（称为模数）后清零，循环往复。这个模数决定了PWM信号的周期）
- 举例：假设模数设为9，计数器会从0数到9，总共10个状态，构成一个完整的周期。
- PWM定时器通常会有个预分频器，用来把主时钟频率降低，方便控制计数器的速度，这里我们假设主时钟频率24 MHz，预分频器可选1、2、4、8、16、32、64、128
- 预分频器的值决定了计数器的时钟频率，计数器的时钟频率 = 主时钟频率 / 预分频器的值
- 当预分频器设为8，计数器的时钟频率为24 MHz / 8 = 3 MHz

2.脉宽调制（占空比调节）
- 脉宽调制核心在于固定频率的条件下通过设置“宽度寄存器”值W控制高电平时间改变占空比，这里我们还是以上面的例子继续讲解：
- 我们需求电机静止脉宽：1.5毫秒，最大顺时针速度脉宽：1毫秒，最大逆时针速度脉宽：2毫秒
- 脉宽时间tW = W × 0.333微秒，W是宽度寄存器的值，由此
- 电机静止：1.5毫秒 ÷ 0.333微秒 ≈ 4500
- 最大顺时针速度：1毫秒 ÷ 0.333微秒 ≈ 3000
- 最大逆时针速度：2毫秒 ÷ 0.333微秒 ≈ 6000

### 1.1 PWM驱动模块概述
- **功能描述**：PWM 驱动模块（PWM Driver）是介于微控制器（或数字信号处理器）和功率器件（如 MOSFET、IGBT、直流电机、电机驱动桥等）之间的专用电路/软件模块
- **应用场景**：电机控制、LED 调光、功率转换等
- **核心特性**：以高精度、高速率、低损耗、强保护和良好兼容性，把数字占空比／频率指令转化为可靠的功率开关动作，从而对电机、LED、开关电源等负载实现高效、精细和安全的控制。

### 1.2 飞腾派PWM硬件接口介绍
- **物理接口**：本型号飞腾派的 PWM 模块提供了 8 个 PWM 控制器，编号从 0 到 7， 每个PWM控制器有 4K 地址空间，并各自有两个输出通道（为了区分PWM控制器和pwm输出通道，后续大写PWM若无说明即为控制器，小写pwm即为pwm输出通道）， 其中 0～1K 为死区控制部分；1～2K 为通道0；2～3K为通道1 
- **接线要求**：（这里只是对硬件进行说明，驱动编写无需修改这部分内容）
  - 每个PWM控制器的两个输出通道分别对应一个PWM输出引脚，用户可根据实际需求将PWM输出引脚连接到负载上（如电机、LED等）
  - 每个PWM控制器的输入时钟引脚需要连接到系统时钟上
  - 每个PWM控制器的使能引脚需要连接到系统使能线上
- **接口约束**：
  - 电气特性约束
    - 输出电压电平：PWM输出引脚采用3.3V CMOS电平标准，高电平电压范围2.4V~3.3V，低电平电压范围0V~0.8V，需与负载端电平兼容（不支持5VTTL电平直接驱动）。
    - 最大输出电流：单通道PWM输出引脚持续输出电流≤20mA，峰值电流≤50mA（持续时间≤100ms），超出范围可能导致引脚烧毁或芯片过热保护。
    - 输入时钟兼容性：PWM控制器输入时钟需满足1.8V±5%电压范围，频率范围1MHz~50MHz，超出范围将导致计数异常或控制器锁死。
  - 信号完整性约束
    - 上升/下降时间：PWM输出信号上升时间（10%~90%电平）≤10ns，下降时间（90%~10%电平）≤10ns，高频场景（>1MHz）需控制在5ns以内以减少电磁辐射。
    - 阻抗匹配：PWM输出路径建议串联50Ω终端电阻（靠近负载端），与传输线特性阻抗匹配（推荐50Ω或75Ω），避免高频信号反射导致波形失真。
    - 抗干扰要求：PWM信号线与大功率电源线（如电机驱动线）间距≥2cm，并行布线长度≤10cm，交叉布线时采用90°垂直交叉以降低电磁耦合干扰。

### 1.3 飞腾派PWM控制器介绍
首先说明下文一个重要概念：Duty cycle , 占空比，一般以 Duty 代指
- **硬件架构**：PWM控制器是飞腾派SoC中的独立外设模块（非MIO控制器），提供 ​**​2个完全独立的compare输出通道​​**。通过 ​​APB总线​​ 进行寄存器配置，核心功能是生成精确的PWM波形，用于电机控制、电源转换等场景。​但 **​不支持capture模式​**​（仅输出），需提前配置PAD复用寄存器以启用功能。
- **功能模块**：
  - **计数器**（核心逻辑单元）：支持两种计数模式如下
    - Modulo模式：计数至PWM_PERIOD值后复位。
    - Up and down模式：递增至PERIOD后递减至0。
  - **比较器**（核心逻辑单元）：实时对比计数器值与设定值（PWM_CCR或FIFO数据），触发输出跳变
  - **FIFO缓冲**（动态数据管理）：
    - Duty值可动态加载：APB写入PWM_CCR时数据同步存入FIFO，避免频繁操作寄存器。
    - ​​空/满状态处理​​：FIFO空时输出保持原值，触发中断（需使能）；FIFO满时阻塞APB写操作（STAT[3]=1）。
  - **中断控制器**​：所有中断通过STATE寄存器标志位汇总，由全局中断控制寄存器使能/屏蔽。按中断源类型分类如下
    - 计数中断​​：周期结束触发（Modulo模式）或计数归零触发（Up-down模式）。
    - 比较中断​​：计数器值等于Duty值时触发。
    - FIFO空中断​​：仅FIFO模式下有效。
  - **死区控制模块**：
    - 死区延迟配置：可通过DBDLY寄存器配置上升/下降沿延迟周期。
    - DBCTRL寄存器控制信号路径（旁路、翻转逻辑）。
- **操作模式**：
  - 唯一工作模式：Compare输出模式
    - 输出逻辑​​：计数器与设定值匹配时，输出引脚按PWM_CTRL.CMP配置：
置0、置1或翻转，输出信号 ​​glitch-free​​（毛刺抑制）。
    - ​Duty值来源​​如下表所示

| 模式 | 数据源 | 特性 |
| --- | ----- | --- |
| 寄存器模式 | PWM_CCR寄存器 | Duty值实时更新，但新值在​​计数器归零时生效​​ |
| FIFO模式 | FIFO缓冲队列 | 动态加载Duty值，减少总线负载 |
- **计数模式**：
  - Modulo模式：计数器值等于PWM_PERIOD时复位，单向计数。
  - Up and down模式：计数器值在0和PWM_PERIOD之间循环，举例：设置period为5,计数器值从0开始递增，当计数器值等于5时，再递减为0,以此类推
- **时钟和电源**：
  - **时钟源**​​：固定 ​​50MHz主时钟​​
  - **分频控制**​​：通过TIM_CTRL寄存器配置分频系数，​​支持运行时动态调整​​
  - **暂停状态**：禁用PWM（TIM_CTRL.ENABLE=0）时，计数器清零，输出分频时钟还原为50MHz
- **复位与初始化​**：
  - ​​**上电复位流程​**：
    - ​配置TIM_CTRL（分频系数、计数模式），​**​不使能PWM​​**。
    - 设定PWM_PERIOD（周期值）和PWM_CTRL（工作模式）。
    - 写入初始Duty值（PWM_CCR或FIFO）。
    - **关键要求​​**：FIFO模式需 ​​预填充数据​​，否则使能后立即触发异常中断
    - 置位TIM_CTRL.ENABLE=1启动PWM。
  - **全局使能控制**：多PWM同步通过寄存器0x2807E020控制（Bit0~1对应PWM0/1）

**总结PWM控制器注意事项（约束条件）**
| 项目 | 约束条件 |
| --- | --- |
| 模式切换 | 变更计数模式必须**禁用PWM​​（ENABLE=0）**，否则行为未定义 |
| Duty值更新​ | 寄存器模式下，新Duty值在**​计数器归零时生效​​**；**禁止Duty > Period** |
| 死区配置​ | 需在**​PWM启动前​​**通过DBDLY/DBCTRL设置 |
| 中断触发​ | 周期值（PERIOD）为0时，​**​不产生任何中断** |​​


## 2. 飞腾派PWM驱动API调用表
本节定义飞腾派PWM驱动模块提供的软件接口（API），便于开发者与硬件模块交互。

### 2.1 API概述

## 1. API概览
| **功能分类**       | **API函数**            | **核心功能描述**                                  |
|-------------------|------------------------|------------------------------------------------|
| 初始化配置         | `configure_channel`    | 配置PWM通道参数（频率/占空比/计数模式等）          |
| 通道控制           | `enable_channel`       | 启用指定通道输出                                |
|                   | `disable_channel`      | 立即禁用通道输出                                |
|                   | `safe_stop_channel`    | 安全停止通道（完成当前周期）                    |
| 数据管理           | `push_fifo_data`       | 向FIFO模式通道推送占空比数据                    |
| 中断处理           | `handle_interrupt`     | 处理控制器中断事件（FIFO空/计数溢出等）          |
| 系统控制           | `global_enable`        | 全局使能所有已配置的PWM控制器               |
| **API函数**          | **描述**                                                     | **参数**                                                     | **返回值**                                       |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------ |
| ​​PwmDriver::new  | 创建 PWM 驱动实例并映射硬件寄存器。 | base_addr: PWM 控制器的物理基地址 | 初始化的 PwmDriver 对象  |
| configure_channel   | 配置 PWM 通道参数  | channel: PWM 通道号 (0-7)、config: PwmConfig 结构体，包含：frequency: PWM 频率 (Hz)、duty_cycle: 占空比 (0.0-1.0)、counting_mode: 计数模式 (Modulo/UpAndDown)、deadtime_ns: 死区时间 (纳秒)、use_fifo: 是否使用 FIFO 模式                 | Option：成功：Ok(())；失败：错误信息（如无效通道、占空比越界等）      |
| ​​init_fifo_mode   | 初始化 FIFO 模式                    | channel: PWM 通道号、     initial_duty: 初始占空比值                              | Option：成功：Ok(())；失败：错误信息  |
| ​​push_fifo_data    | 向 FIFO 推送占空比数据 | channel: PWM 通道号；duty_value: 16 位占空比值 | Option：成功：Ok(())；失败：错误信息          |
| enable_channel   | 启用 PWM 通道输出 | channel: PWM 通道号 | 无  |
| safe_stop_channel      | 安全停止 PWM 输出（防电源瞬变） | channel: PWM 通道号 | 无  |
| enable_multiple_channels | 同时启用多个 PWM 通道 | mask: 通道掩码（bit0=通道0, bit1=通道1, ...） | 无    |
| handle_interrupt     | 处理 PWM 中断               | 无 | 无  |
| pwm_init  | 初始化 PWM 控制器（高级封装）                  | base_addr: PWM 控制器物理基地址                          | 初始化的 PwmDriver 对象       |

