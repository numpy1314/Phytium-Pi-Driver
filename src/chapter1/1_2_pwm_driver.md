# 1.2 PWM驱动开发
## 1. PWM工作原理
PWM（Pulse Width Modulation）​​ 是一种通过调节脉冲宽度（占空比）来模拟不同模拟量输出的数字控制技术。它利用数字信号（高/低电平）控制模拟电路，广泛应用于电机调速、电源转换、LED调光等领域。其核心是通过调整脉冲的“有效时间比例”实现连续可调的电压、功率或信号输出
![](/src/resource/img/1_2_1_Working_principle_of_PWM.png)
PWM 最关键的两个参数：频率和占空比。

频率是指单位时间内脉冲信号的周期数。比如开关灯，开关一次算一次周期，在 1s 进行多少次开关（开关一次为一个周期）。

占空比是指一个周期内高电平时间和低电平时间的比例。也拿开关当作例子，总共 100s，开了 50s 灯（高电平），关了 50s 灯（低电平），这时候的占空比就为 50%（比例）。

尽管大部分元件仅有高低电平的输出，PWM 仍可通过改变占空比来实现模拟信号量的输出，核心就是输出的平均电压随占孔比的改变而变化，除此之外采用高频率也能让机器更加顺滑地改变占空比

具体生成过程：

1.周期设定（调节频率）
- 通过定时器计数器设定周期值（PWM定时器的工作方式有点像一个精准的节拍器。它的核心是一个计数器，从0开始计数，数到某个设定值（称为模数）后清零，循环往复。这个模数决定了PWM信号的周期）
- 举例：假设模数设为9，计数器会从0数到9，总共10个状态，构成一个完整的周期。
- PWM定时器通常会有个预分频器，用来把主时钟频率降低，方便控制计数器的速度，这里我们假设主时钟频率24 MHz，预分频器可选1、2、4、8、16、32、64、128
- 预分频器的值决定了计数器的时钟频率，计数器的时钟频率 = 主时钟频率 / 预分频器的值
- 当预分频器设为8，计数器的时钟频率为24 MHz / 8 = 3 MHz

2.脉宽调制（占空比调节）
- 脉宽调制核心在于固定频率的条件下通过设置“宽度寄存器”值W控制高电平时间改变占空比，这里我们还是以上面的例子继续讲解：
- 我们需求电机静止脉宽：1.5毫秒，最大顺时针速度脉宽：1毫秒，最大逆时针速度脉宽：2毫秒
- 脉宽时间tW = W × 0.333微秒，W是宽度寄存器的值，由此
- 电机静止：1.5毫秒 ÷ 0.333微秒 ≈ 4500
- 最大顺时针速度：1毫秒 ÷ 0.333微秒 ≈ 3000
- 最大逆时针速度：2毫秒 ÷ 0.333微秒 ≈ 6000

### 1.1 PWM驱动模块概述
- **功能描述**：PWM 驱动模块（PWM Driver）是介于微控制器（或数字信号处理器）和功率器件（如 MOSFET、IGBT、直流电机、电机驱动桥等）之间的专用电路/软件模块
- **应用场景**：电机控制、LED 调光、功率转换等
- **核心特性**：以高精度、高速率、低损耗、强保护和良好兼容性，把数字占空比／频率指令转化为可靠的功率开关动作，从而对电机、LED、开关电源等负载实现高效、精细和安全的控制。

### 1.2 飞腾派PWM硬件接口介绍
- **物理接口**：本型号飞腾派的 PWM 模块提供了 8 个 PWM 控制器，编号从 0 到 7， 每个PWM控制器有 4K 地址空间，并各自有两个输出通道（为了区分PWM控制器和pwm输出通道，后续大写PWM若无说明即为控制器，小写pwm即为pwm输出通道）， 其中 0～1K 为死区控制部分；1～2K 为通道0；2～3K为通道1 
- **接线要求**：（这里只是对硬件进行说明，驱动编写无需修改这部分内容）
  - 每个PWM控制器的两个输出通道分别对应一个PWM输出引脚，用户可根据实际需求将PWM输出引脚连接到负载上（如电机、LED等）
  - 每个PWM控制器的输入时钟引脚需要连接到系统时钟上
  - 每个PWM控制器的使能引脚需要连接到系统使能线上
- **接口约束**：
  - 电气特性约束
    - 输出电压电平：PWM输出引脚采用3.3V CMOS电平标准，高电平电压范围2.4V~3.3V，低电平电压范围0V~0.8V，需与负载端电平兼容（不支持5VTTL电平直接驱动）。
    - 最大输出电流：单通道PWM输出引脚持续输出电流≤20mA，峰值电流≤50mA（持续时间≤100ms），超出范围可能导致引脚烧毁或芯片过热保护。
    - 输入时钟兼容性：PWM控制器输入时钟需满足1.8V±5%电压范围，频率范围1MHz~50MHz，超出范围将导致计数异常或控制器锁死。
  - 信号完整性约束
    - 上升/下降时间：PWM输出信号上升时间（10%~90%电平）≤10ns，下降时间（90%~10%电平）≤10ns，高频场景（>1MHz）需控制在5ns以内以减少电磁辐射。
    - 阻抗匹配：PWM输出路径建议串联50Ω终端电阻（靠近负载端），与传输线特性阻抗匹配（推荐50Ω或75Ω），避免高频信号反射导致波形失真。
    - 抗干扰要求：PWM信号线与大功率电源线（如电机驱动线）间距≥2cm，并行布线长度≤10cm，交叉布线时采用90°垂直交叉以降低电磁耦合干扰。

### 1.3 飞腾派PWM控制器介绍
首先说明下文一个重要概念：Duty cycle , 占空比，一般以 Duty 代指
- **硬件架构**：PWM控制器是飞腾派SoC中的独立外设模块（非MIO控制器），提供 ​**​2个完全独立的compare输出通道​​**。通过 ​​APB总线​​ 进行寄存器配置，核心功能是生成精确的PWM波形，用于电机控制、电源转换等场景。​但 **​不支持capture模式​**​（仅输出），需提前配置PAD复用寄存器以启用功能。
- **功能模块**：
  - **计数器**（核心逻辑单元）：支持两种计数模式如下
    - Modulo模式：计数至PWM_PERIOD值后复位。
    - Up and down模式：递增至PERIOD后递减至0。
  - **比较器**（核心逻辑单元）：实时对比计数器值与设定值（PWM_CCR或FIFO数据），触发输出跳变
  - **FIFO缓冲**（动态数据管理）：
    - Duty值可动态加载：APB写入PWM_CCR时数据同步存入FIFO，避免频繁操作寄存器。
    - ​​空/满状态处理​​：FIFO空时输出保持原值，触发中断（需使能）；FIFO满时阻塞APB写操作（STAT[3]=1）。
  - **中断控制器**​：所有中断通过STATE寄存器标志位汇总，由全局中断控制寄存器使能/屏蔽。按中断源类型分类如下
    - 计数中断​​：周期结束触发（Modulo模式）或计数归零触发（Up-down模式）。
    - 比较中断​​：计数器值等于Duty值时触发。
    - FIFO空中断​​：仅FIFO模式下有效。
  - **死区控制模块**：
    - 死区延迟配置：可通过DBDLY寄存器配置上升/下降沿延迟周期。
    - DBCTRL寄存器控制信号路径（旁路、翻转逻辑）。
- **操作模式**：
  - 唯一工作模式：Compare输出模式
    - 输出逻辑​​：计数器与设定值匹配时，输出引脚按PWM_CTRL.CMP配置：
置0、置1或翻转，输出信号 ​​glitch-free​​（毛刺抑制）。
    - ​Duty值来源​​如下表所示

| 模式 | 数据源 | 特性 |
| --- | ----- | --- |
| 寄存器模式 | PWM_CCR寄存器 | Duty值实时更新，但新值在​​计数器归零时生效​​ |
| FIFO模式 | FIFO缓冲队列 | 动态加载Duty值，减少总线负载 |
- **计数模式**：
  - Modulo模式：计数器值等于PWM_PERIOD时复位，单向计数。
  - Up and down模式：计数器值在0和PWM_PERIOD之间循环，举例：设置period为5,计数器值从0开始递增，当计数器值等于5时，再递减为0,以此类推
- **时钟和电源**：
  - **时钟源**​​：固定 ​​50MHz主时钟​​
  - **分频控制**​​：通过TIM_CTRL寄存器配置分频系数，​​支持运行时动态调整​​
  - **暂停状态**：禁用PWM（TIM_CTRL.ENABLE=0）时，计数器清零，输出分频时钟还原为50MHz
- **复位与初始化​**：
  - ​​**上电复位流程​**：
    - ​配置TIM_CTRL（分频系数、计数模式），​**​不使能PWM​​**。
    - 设定PWM_PERIOD（周期值）和PWM_CTRL（工作模式）。
    - 写入初始Duty值（PWM_CCR或FIFO）。
    - **关键要求​​**：FIFO模式需 ​​预填充数据​​，否则使能后立即触发异常中断
    - 置位TIM_CTRL.ENABLE=1启动PWM。
  - **全局使能控制**：多PWM同步通过寄存器0x2807E020控制（Bit0~1对应PWM0/1）

**总结PWM控制器注意事项（约束条件）**
| 项目 | 约束条件 |
| --- | --- |
| 模式切换 | 变更计数模式必须**禁用PWM​​（ENABLE=0）**，否则行为未定义 |
| Duty值更新​ | 寄存器模式下，新Duty值在**​计数器归零时生效​​**；**禁止Duty > Period** |
| 死区配置​ | 需在**​PWM启动前​​**通过DBDLY/DBCTRL设置 |
| 中断触发​ | 周期值（PERIOD）为0时，​**​不产生任何中断** |​​


## 2. 飞腾派PWM驱动API调用表
本节定义飞腾派PWM驱动模块提供的软件接口（API），便于开发者与硬件模块交互。

### 2.1 API概述

| **功能分类**       | **API函数**            | **核心功能描述**                                  |
|-------------------|------------------------|------------------------------------------------|
| 初始化配置         | `PwmController：：new`    | 创建 PWM 驱动实例并映射硬件寄存器          |
|                  | `configure_channel`    | 配置PWM通道参数（频率/占空比/计数模式等）          |
| 通道控制           | `enable_channel`       | 启用指定通道输出                                |
|                   | `disable_channel`      | 立即禁用通道输出                                |
|                   | `safe_stop_channel`    | 安全停止通道（完成当前周期）                    |
| 数据管理           | `push_fifo_data`       | 向FIFO模式通道推送占空比数据                    |
| 中断处理           | `handle_interrupt`     | 处理控制器中断事件（FIFO空/计数溢出等）          |
|                   | `handle_channel_interrupt`     | 处理单个通道中断（FIFO空/计数溢出/比较匹配中断等）          |
| 系统控制           | `PwmSystem：：new`        | 创建PWM系统（初始化8个控制器）               |
|                   | `global_enable`        | 全局使能所有已配置的PWM控制器  |       

### 2.2 API调用表
| API函数 | 描述 | 参数 | 返回值 |
|---------|------|------|--------| 
| ​​PwmSystem::new()​ | 初始化PWM系统，设置所有控制器的基地址	 | 无 | 返回初始化完成的PwmSystem实例 |
| ​​PwmSystem::global_enable()​ | 全局使能所有已配置的PWM控制器 | 无 | 无 |
| PwmSystem::controller()​ | 获取指定索引的PWM控制器实例 | index: usize - 控制器索引（0-7） | Option<&mut PwmController> - 成功返回控制器引用，无效索引返回None |
| ​​PwmController::configure_channel()​ | 配置PWM通道参数 | channel: usize - 通道号（0或1）config: PwmConfig - 配置结构体（含频率、占空比等）| Result<(), &str> - 成功返回Ok(())，错误返回错误描述 |
| PwmController::enable_channel()​ | 启用通道输出 | channel: usize - 通道号（0或1） | Result<(), &str> - 成功返回Ok(())，无效通道返回错误 |
| PwmController::disable_channel()​ | 禁用通道输出 | channel: usize - 通道号（0或1） | 无 |
| PwmController::safe_stop_channel()​ | 安全停止通道（完成当前周期） | channel: usize - 通道号（0或1） | Result<(), &str> - 成功返回Ok(())，超时返回错误 |
| PwmController::push_fifo_data()​ | 向FIFO模式通道推送占空比数据 | channel: usize - 通道号（0或1）, duty: u16 - 占空比值 | Result<(), &str> - 成功返回Ok(())，FIFO满返回错误 |
| PwmController::handle_interrupt()​ | 处理控制器中断事件 | 无 | 无 |
| PwmController::handle_channel_interrupt()​ | 处理单个通道中断 | channel: usize - 通道号（0或1） | 无 |

**调用顺序**
- 初始化系统​​
  - PwmSystem::new() → 创建PWM系统实例
- ​​配置通道​​
  - PwmSystem::controller(index) → configure_channel(channel, config)需先获取控制器，再配置具体通道
- ​启用通道​​
  - enable_channel(channel) → 激活输出
- 全局使能​​
  - global_enable() → 启动所有已配置控制器
- 运行时操作​​
  - FIFO数据更新：push_fifo_data(channel, duty_value)
  - 安全停止：safe_stop_channel(channel)
  - 中断处理：handle_interrupt()
- 禁用通道​​
  - disable_channel(channel) → 立即停止输出

**错误处理**
| 错误场景 | 错误返回值 | 原因 |
| ------- | -------- | ------- |
| 无效通道号 | Err("Invalid channel number") | 通道号超出有效范围（0-1） |
| 占空比超限 | Err("Duty cycle must be between 0.0 and 1.0") | 占空比值超出有效范围（0.0-1.0） |
| 周期值过大 | Err("Period value too large") | 周期值超过最大限制（0xFFFF） |
| FIFO已满 | Err("FIFO is full") | 向FIFO模式通道推送数据时，FIFO已满 |
| 安全停止超时 | 隐含超时（未显式返回） | 安全停止操作超时（未完成当前周期） |

**关键错误处理逻辑**：
- **配置阶段**：参数校验严格（如占空比范围、周期值溢出）
- **运行时**：状态检查（如FIFO满标志）
- **安全停止**：阻塞等待周期完成（while tim_cnt != 0）


## 3. 飞腾派PWM驱动相关寄存器结构
本节详细描述飞腾派中用于配置和控制PWM相关硬件模块的寄存器，为PWM驱动实现提供清晰的硬件映射。

### 3.1寄存器组
- **寄存器分类**：主要分成四类，控制，状态，数据，中断。值得注意的是这里的中断并非专门分出一个寄存器使能控制，而是通过寄存器中的位来使能中断，下表中有详细说明。

| 寄存器 | 偏移/位（中断） | 描述 |
| --- | --- | --- |
| **控制寄存器** | **CTRL** | **配置PWM模式、使能、时钟源等** |
| DBCTRL | 0x00 | 死区模式控制（输出模式、极性选择、软复位） |
| TIM_CTRL | 0x404/0x808 | 计数模式、分频参数、全局使能、软复位 |
| PWM_CTRL | 0x410/0x810 | PWM工作模式（比较操作、Duty值来源、中断使能） |
| DBDLY（相对特殊） | 0x04 | 控制PWM输出信号的边沿延时​​，选择死区作用模式和输出极性 |
| **状态寄存器** | **STATUS** | **反映PWM内部状态和中断标志** |
| STATE | 0x408/0x808 | FIFO状态标志（如FIFO_FULL） |
| **数据寄存器** | **DATA** | **存储计数器值和周期参数** |
| TIM_CNT | 0x400/0x800 | 内部Timer计数值 |
| PWM_PERIOD | 0x40C/0x80C | 周期寄存器（控制计数范围） |
| PWM_CCR | 0x414/0x814 | 比较值寄存器（控制Duty）|
| **中断寄存器** | **INT** | **配置中断使能和触发条件** |
| STATE.FIFO_EMPTY | 2 | 只有在选择使用 FIFO 作为 duty 控制，且 FIFO 为空的时候，产生中断|
| STATE.OVFIF | 1 | 计数中断，不同计数模式下有不同定义<br>modulo：当计数值达到 PWM_PERIOD 寄存器值时，产生中断<br>up and down：当 PWM_PERIOD 非 0，此时，若计数值递减为 0的时候，产生中断(但整体处于复位时候不产生)，若PWM_PERIOD 为 0，无中断<br>注意：计数是在分频后的时钟域，产生的中断脉冲信号相对于 clk_fio 会很宽，为了避免重复对状态寄存器赋值，使用上升沿检测来置位|
| STATE.CHIF | 0 | compare 中断标志，写 1 清除|
| TIM_CTRL.GIE | 5 | 全局中断使能，写 1 使能，写 0 禁用|
| TIM_CTRL.OVFIE | 4 | counter-overflow 中断使能控制位|
| PWM_CTRL.FIFO_EMPTY_ENABLE | 9 | 在 compare 模式下，FIFO 出现空的时候，中断输出使能控制位，1 表示使能，0 表示非使能，即使非使能，FIFO 空的时候也要置位状态寄存器相关位，但不输出中断|
| PWM_CTRL.IE | 3 | 中断使能位，用来控制是否产生 compare 中断。该位为 0 表示 compare 中断使能无效，1 表示 compare 中断使能有效|

### 3.2寄存器块基地址
3.1中主要是描述一个PWM控制器的寄存器组，每个控制器都有3.1中描述的一套寄存器组各自进行控制，而3.2则是对八个控制器的基地址进行描述

| 控制器 | 基地址 |
| --- | --- |
| PWM0 | 0x000_2804_A000 |
| PWM1 | 0x000_2804_B000 |
| PWM2 | 0x000_2804_C000 |
| PWM3 | 0x000_2804_D000 |
| PWM4 | 0x000_2804_E000 |
| PWM5 | 0x000_2804_F000 |
| PWM6 | 0x000_2805_0000 |
| PWM7 | 0x000_2805_1000 |

得到了每个控制器的基地址，就可以通过基地址和偏移量来访问每个控制器的寄存器了。

### 3.3寄存器位域
| 域 | 位 | 复位值 | 描述 |
| --- | --- | --- | --- |
| **DBCTRL** |  |  |  |
| reserved | 31:6 | 0x0 | 保留 |
| OUT_MODE | 5:4 | 0x0 | 死带输出模式控制：<br>00：bypass<br>01：禁用上升沿延迟，pwm0_out 直接输出，下降沿延迟作用在 pwm1_out<br>10：禁用下降沿延迟，pwm1_out 直接输出，上升沿延迟作用在 pwm0_out<br>11：pwm0_out 上升沿和 pwm1_out 下降沿都完全启用死带 |
| POLSEL | 3:2 | 0x0 | 极性选择控制：<br>00：active high(AH) pwm0_out 和 pwm1_out 都不翻转<br>01：active low complementary(ALC) pwm0_out 翻转<br>10：active high complementary(AHC) pwm1_out 翻转<br>11：active low(AL) pwm0_out 和 pwm1_out 都翻转 |
| IN_MODE | 1 | 0x0 | 死区输入 pwm 源选择：<br>0：pwm0 输入<br>1：pwm1 输入 |
| DB_SW_RST | 0 | 0x0 | 全局软复位信号，软件写 1，部件实现全局软复位，复位完成后，自动跳出软复位<br>软件读取到 1 的时候，表示处于复位中<br>软件读取到 0 的时候，表示跳出复位，可以进行功能操作。 |
| **DBDLY** |  |  |  |
| reserved | 31:20 | 0x0 | 保留 |
| DBFED | 19:10 | 0x0 | 下降沿延迟周期 |
| DBRED | 9:0 | 0x0 | 上升沿延迟周期 |
| **tim_cnt** |  |  |  |
| reserved | 31:16 | 0x0 | 保留 |
| cnt | 15:0 | 0x0 | 计数标志 |
| **tim_ctrl** |  |  |  |
| reserved | 31:28 | 0x0 | 保留 |
| DIV | 27:16 | 0x0 | 分频参数<br>0：1 分频<br>1：2 分频<br>…<br>支持分频范围：1~4096 |
| reserved | 15:6 | 0x0 | 保留 |
| GIE | 5 | 0x0 | 全局中断使能控制位 |
| OVFIE | 4 | 0x0 | counter-overflow中断使能控制位 |
| reserved | 3 | 0x0 | 保留 |
| Mode | 2 | 0x0 | 计数模式<br>0：modulo<br>1：up and down<br>工作中，计数模式的修改，需要先 disable 全局，修改后再 enable |
| ENABLE | 1 | 0x0 | 使全局使能位<br>1 表示全局使能，0 表示不使能<br>0：diable，计数器清零，compare 停止工作，输出复位值，寄存器内容保持原值；<br>1：enable，Timer&PWM 正常工作<br>若需要暂停 Timer/PWM 工作，可通过该位控制。 |
| SW_RST | 0 | 0x0 | 全局软复位信号，软件写 1，部件实现全局软复位，复位完成后，自动跳出软复位。<br>软件读取到 1 的时候，表示处于复位中<br>软件读取到 0 的时候，表示跳出复位，可以进行功能操作 |
| **state** |  |  |  |
| reserved | 31:4 | 0x0 | 保留 |
| FIFO_FULL | 3 | 0x0 | 该位显示当前 FIFO 满的情况，但是不作为中断输出，在软件向 FIFO 中写数据的时候作为前提，若检测到该位是 1，则此时不允许写数据，否则 APB 总线可能会被堵塞，但是 FIFOfull 不会输出中断 |
| FIFO_EMPTY | 2 | 0x0 | 只有在选择使用 FIFO 作为 duty 控制，且 FIFO 为空的时候，产生中断 |
| OVFIF | 1 | 0x0 | 计数中断，不同计数模式下有不同定义<br>modulo：当计数值达到 PWM_PERIOD 寄存器值时，产生中断<br>up and down：当 PWM_PERIOD 非 0，此时，若计数值递减为 0 的时候，产生中断(但整体处于复位时候不产生)，若PWM_PERIOD 为 0，无中断<br>注意：计数是在分频后的时钟域，产生的中断脉冲信号相对于 clk_fio 会很宽，为了避免重复对状态寄存器赋值，使用上升沿检测来置位。 |
| CHIF | 0 | 0x0 | compare 中断标志位,写 1 清除 |
| **pwm_period** |  |  |  |
| reserved | 31:16 | 0x0 | 保留 |
| CCR | 15:0 | 0x0 | 计数控制功能，在非Free-running 模式线下，该值是用来控制 counter 归零等情况的，即 period 寄存器；该寄存器的值支持工作中动态调整（compare 模式下，实际输出 period 周期数为此值+1） |
| **pwm_ctrl** |  |  |  |
| reserved | 31:10 | 0x0 | 保留 |
| FIFO_EMPTY_ENABLE | 9 | 0x0 | 在 compare 模式下，FIFO 出现空的时候，中断输出使能控制位，1 表示使能，0 表示非使能，即使非使能，FIFO 空的时候也要置位状态寄存器相关位，但不输出中断 |
| DUTY_SEL | 8 | 0x0 | compare 模式下，控制 duty 的比较值的来源<br>0：来自寄存器 PWM_CCR；<br>1：来自 FIFO，fifo 值由 PWM_CCR.ccr 写入<br>duty 值来自寄存器的时候，只在上一个 pwm 周期结束的时候 load 当前 pwm_ccr 寄存器的值，比如说在一个 pwm 周期内多次写这个寄存器，那么只有最后一个值有效；来自 FIFO时，当 FIFO 非满时，这些值会存储在 FIFO 内，硬件在每个pwm 周期结束时自动读出做为下一次的 duty 值 |
| ICOV | 7 | 0x0 | 在 compare 模式下，配置 PWM 输出的初始值，跳出全局复位后，初始值根据当前设定，在 enable 信号使能之前，需先配置好该值 |
| CMP | 6:4 | 0x0 | 比较操作配置。<br>000：比较匹配时输出置 1<br>001：比较匹配时输出清 0<br>010：比较匹配时输出翻转<br>011：向上计数且比较匹配时输出置 1。然后在 up-and-down 模式向下计数且比较匹配时输出清 0，其他模式则在计数到 0 时输出清 0;<br>100：向上计数且比较匹配时输出清 0。然后在 up-and-down模式向下计数且比较匹配时输出置 1，其他模式则在计数到 0 时输出置 1;<br>101 ： 计 数 值 等 于 PWM_CCR.ccr 时 输 出 清 0 ， 等 于pwm_period.ccr 时输出置 1;<br>110 ： 计 数 值 等 于PWM_CCR.ccr 时 输 出 置 1 ， 等于 pwm_period.ccr 时输出清 0;<br>111：输出管脚初始化<br>说明：对于“010：比较匹配时输出翻转”，比较匹配是指counter 值变化后匹配；如果初始值相同，不算比较匹配上;<br>对于“000：比较匹配时输出置 1”、“001：比较匹配时输出清 0”、“101”和“110”不涉及一直翻转的模式，比较匹配是指 counter 值初次匹配。<br>对于“011”“100”比较匹配也指 counter 值初次匹配，但是否跳变，还要看当前计数器的计数方向。|
| IE | 3 | 0x0 | 中断使能位，用来控制是否产生 compare 中断<br>该位为 0 表示 compare 中断使能无效，1 表示 compare 中断使能有效。 |
| Mode | 2 | 0x0 | 1：比较模式 |
| reserved | 1 | 0x0 | 保留 |
| **pwm_ccr** |  |  |  |
| reserved | 31:17 | 0x0 | 保留 |
| GPIO | 16 | 0x0 | 输出GPIO控制位 |
| CCR | 15:0 | 0x0 | compare 模式：该寄存器的值属于控制 duty cycle 的，此时，该值最小为 1，最大不能超过 pwm_period.ccr 的值 |

## 4. 具体实现讲解
本节详细讲解PWM驱动实现步骤，提供实用开发指南和代码示例
### 4.1 飞腾派PWM驱动架构
- **驱动类型**：本驱动适用于CEK8903飞腾派硬件开发板上针对ArceOS开发的PWM模块
- **模块依赖**： 本驱动主要引入了tock_registers、cortex_m、core以及ArceOS的中断处理等库

### 4.2 飞腾派PWM驱动初始化流程
#### 硬件初始化
1. **时钟配置**
- 系统时钟频率通过常量 SYSTEM_CLK = 50_000_000 定义（50MHz），需确保与实际硬件一致。
- PWM 时钟源通常来自 APB 总线（参考 STM32 时钟树设计），需确认芯片手册中 PWM 挂载的总线
2. **引脚复用**
- 通过 PwmConfig 结构体配置输出行为（如死区时间、极性），硬件自动处理引脚复用。
- 例如：设置 deadtime_ns 会触发死区控制寄存器（DBCTRL 和 DBDLY）的写入
3. **寄存器基址映射**
- 将PWM控制器基地址按文档定义进行设置
```rust
const CONTROLLER_BASES: [usize; PWM_CONTROLLERS] = [
            0x2804_A000, // PWM0
            0x2804_B000, // PWM1
            0x2804_C000, // PWM2
            0x2804_D000, // PWM3
            0x2804_E000, // PWM4
            0x2804_F000, // PWM5
            0x2805_0000, // PWM6
            0x2805_1000, // PWM7
];
```
- 通过 PwmRegisters 结构体访问寄存器，利用内存映射 I/O 直接操作硬件。

#### 软件初始化
1. **层级结构（三级）**
- **PwmSystem**​​：管理系统所有 PWM 控制器（8个）
```rust
pub struct PwmSystem {
    controllers: [PwmController; PWM_CONTROLLERS],
}
```
- **PwmController**：管理单个 PWM 控制器的两个通道，负责初始化和配置单个 PWM 模块
```rust
pub struct PwmController {
    base: usize,
    channels: [PwmChannel; CHANNELS_PER_CONTROLLER],
}
```
- **PwmChannel**：存储通道配置（频率、占空比等）
```rust
pub struct PwmChannel {
    config: Option<PwmConfig>,
    enabled: bool,
}
```
2. **中断注册​**：
- 中断处理函数 ​pwm_interrupt_handler 需注册到系统
```rust
fn pwm_interrupt_handler(controller_idx: usize) {
    if let Some(ctrl) = pwm_system.controller(controller_idx) {
        ctrl.handle_interrupt();
    }
}
```
- 通过 handle_interrupt 方法处理三类中断
  - FIFO 空中断（自动填充数据）
  - 计数器溢出中断
  - 比较匹配中断
- 中断标志清除采用RW1c（写1清除）
